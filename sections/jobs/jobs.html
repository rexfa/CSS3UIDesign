<template class="task-template">
  <section id="jobs-section" class="section js-section u-category-jobs">
    <header class="section-header">
      <div class="section-wrapper">
        <h1>
          <svg class="section-icon">
            <use xlink:href="assets/img/icons.svg#icon-windows"></use>
          </svg>
          任务
        </h1>
        <h3>自动加载 <code>源数据</code> 请根据需求开始运行任务</h3>
      </div>

    </header>
    <div class="workspace">
      <div id="jobsPanel" class="jobs-workspace-wrapper">

      </div>
    </div>
    <div class="jobstemplate">
      <div class="taskpanel" id="taskpanelTTTTT">
        <div class="taskinfopanel">
          <div>任务:<em class="task-name"></em></div>
          <div>操作：<em class="task-operation"></em></div>
          <div>状态：<em class="task-status"></em></div>
          <div>数据规模：<em class="task-scale"></em></div>
          <div>IT：<em class="task-inputtime"></em></div>
          <div>TT：<em class="task-runtime"></em></div>
        </div>
        <div class="controlpanel">
          <hr class="task-hr" />
          <button class="job-operation">
            操作</button><br />
          <div class="controlpanel-hidden">
            <button class="select-script">选择任务脚本</button><br />
            <button class="priority-start">优先开始</button><br />
            <button class="delayed-task">延迟任务</button><br />
            <button class="pause-task">暂停任务</button><br />
            <div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="jobscripttemplate hidden">
      <div>任务脚本选择</div>
      <div class="script-jobname">任务名称:<em></em></div>
      <div class="script-listpanel">脚本列表:
        <ul class="script-listpanelul">
          <li> <label class="script-label">
              <input class="script-radio" type="radio" name="jobscriptradio" value="宏基因组脚本">
              <span class="script-checkbox script-radioInput"></span>宏基因组脚本
            </label></li>
          <li> <label class="script-label">
              <input class="script-radio" type="radio" name="jobscriptradio" value="肠道项目脚本">
              <span class="script-checkbox script-radioInput"></span>肠道项目脚本
            </label></li>
          <li> <label class="script-label">
              <input class="script-radio" type="radio" name="jobscriptradio" value="RNA测序数据">
              <span class="script-checkbox script-radioInput"></span>RNA测序数据
            </label></li>
          <li> <label class="script-label">
              <input class="script-radio" type="radio" name="jobscriptradio" value="用户自定义脚本">
              <span class="script-checkbox script-radioInput"></span>用户自定义脚本
            </label></li>
          <li> <label class="script-label">
              <input class="script-radio" type="radio" name="jobscriptradio" value="人类基因数据">
              <span class="script-checkbox script-radioInput"></span>人类基因数据
            </label></li>
        </ul>
      </div>
      <div>
        <button id="save-script" class="jobscriptsave-button">保存脚本选择</button>
      </div>
    </div>
    <button id="jobs-test"  style="display: none;" class="test-button">测试</button>
    <button id="btn-getjobsdata" style="display: none;">获取工作文件列表</button>
    <div id="jobs-log"></div>

    <script type="text/javascript">
      /* 打开和关闭操作面板 */
      function operationonclick(jobName) {
        var controlpanelID = "controlpanel" + jobName;
        var controlpanel = document.getElementById(controlpanelID);
        var taskpanelID = "taskpanel" + jobName;
        var taskpanel = document.getElementById(taskpanelID);
        var taskinfopanelID = "taskinfopanel" + jobName;
        var taskinfopanel = document.getElementById(taskinfopanelID);
        var taskhrID = "taskhr" + jobName;
        var taskhr = document.getElementById(taskhrID);
        //var infopanel = 
        if (controlpanel.className == "controlpanel-hidden") {
          //taskpanel.style.height = 350;
          controlpanel.className = "controlpanel-display";
          taskinfopanel.classList.add("hidden");
          taskhr.classList.add("hidden");

        } else {
          controlpanel.className = "controlpanel-hidden";
          //taskpanel.style.height = 200;
          taskinfopanel.classList.remove("hidden");
          taskhr.classList.remove("hidden");
        }
      }

      function readJobDataDir() {
        //var path = require('path')
        window.clearInterval(this.CheckDirIntervalID);
        var fs = require('fs');
        var dataPath = ".\\job_data";
        //document.getElementById("jobs-log").innerHTML=dataPath;
        var files = fs.readdirSync(dataPath);
        return files;
      }


      function jobsTest() {
        let ramboName = (+new Date).toString(36)
        addJobInfoPanel(ramboName)
      }
      //引用模板
      function importJobInfoTemplate() {
        let template = document.getElementsByClassName("jobstemplate")
        let clone = template[0].children[0].cloneNode(true)
        setTTTime(clone)
        let workspace = document.getElementsByClassName('jobs-workspace-wrapper')
        workspace[0].appendChild(clone)
      }
      //获取所有的panel
      function getAllJobInfoPanel() {
        let jobs = document.getElementsByClassName('jobs-workspace-wrapper')[0].getElementsByClassName("taskpanel");
        return jobs;
      }
      //获取指定name的panel
      function getJobInfoPanelByJobName(jobName) {
        let job = document.getElementById("taskpanel" + jobName);
        return job;
      }


      function setJTTTime(jobInfoNode) {
        let tt = jobInfoNode.getElementsByClassName("task-runtime")[0];
        let dom = document.createElement('em');
        //dom.className='book';
        dom.innerHTML = CurentTime();
        tt.appendChild(dom);
      }

      function setJITTime(jobInfoNode) {
        let tt = jobInfoNode.getElementsByClassName("task-inputtime")[0];
        let dom = document.createElement('em');
        //dom.className='book';
        dom.innerHTML = CurentTime();
        tt.appendChild(dom);
      }



      /* 显示选择脚本 */
      function selectscriptonclick(jobName) {
        var scriptselector = document.getElementsByClassName("jobscripttemplate")[0];
        scriptselector.classList.remove("hidden");
        let btnSelectScriptSave = document.getElementsByClassName("jobscriptsave-button")[0];
        btnSelectScriptSave.setAttribute("onclick", "selectscriptsaveonclick('" + jobName + "')");
        setCloneDomContent(scriptselector, "script-jobname", "script-jobname", jobName);
      }
      /*保存选择脚本，让选择界面消失 */
      function selectscriptsaveonclick(jobName) {
        var scriptselector = document.getElementsByClassName("jobscripttemplate")[0];
        scriptselector.classList.add("hidden");
        var jobscriptradio = document.getElementsByName("jobscriptradio");
        for (i = 0; i < jobscriptradio.length; i++) {
          if (jobscriptradio[i].checked) {
            setDomContent("taskoperation" + jobName, jobscriptradio[i].value);//设置内容
          }
        }
      }
      /*优先开始*/
      function prioritystartonclick(jobName){
        //var taskstatusdom = document.getElementById("taskstatus" + jobName);
        //taskstatusdom.innerHTML = "开始";
        setDomContent("taskstatus" + jobName,'0%');
        setInterval(function (){callSetJobsStatus("taskstatus" + jobName)}, 2000);//暂时不结束这个Interval
        operationonclick(jobName);
      }
      function callSetJobsStatus(taskstatusDOMId){
        let cvalue = parseInt(getDomContent(taskstatusDOMId));
        if(cvalue<100){
          cvalue = cvalue+5;
          setDomContent(taskstatusDOMId,cvalue+'%');
        }        
      }
      //创建一个工作面板
      function addJobInfoPanel(jobName) {
        let template = document.getElementsByClassName("jobstemplate");
        let clone = template[0].children[0].cloneNode(true);
        clone.setAttribute("id", "taskpanel" + jobName);

        setCloneDomContent(clone, "task-name", "taskname" + jobName, jobName);
        setCloneDomContent(clone, "task-operation", "taskoperation" + jobName, "准备完毕");
        setCloneDomContent(clone, "task-status", "taskstatus" + jobName, "准备");
        setCloneDomContent(clone, "task-scale", "taskscale" + jobName, "10G");
        let btnOperation = clone.getElementsByClassName("job-operation")[0];
        btnOperation.setAttribute("onclick", "operationonclick('" + jobName + "')");
        let btnSelectScript = clone.getElementsByClassName("select-script")[0];
        btnSelectScript.setAttribute("onclick", "selectscriptonclick('" + jobName + "')");
        let btnPriorityStart = clone.getElementsByClassName("priority-start")[0];
        btnPriorityStart.setAttribute("onclick", "prioritystartonclick('" + jobName + "')");
        let controlpanel = clone.getElementsByClassName("controlpanel-hidden")[0];
        controlpanel.setAttribute("id", "controlpanel" + jobName);
        let taskinfopanel = clone.getElementsByClassName("taskinfopanel")[0];
        taskinfopanel.setAttribute("id", "taskinfopanel" + jobName);
        let taskhr = clone.getElementsByClassName("task-hr")[0];
        taskhr.setAttribute("id", "taskhr" + jobName);
        setJITTime(clone);
        setJTTTime(clone);
        document.getElementsByClassName('jobs-workspace-wrapper')[0].appendChild(clone);
      }

      function callJobsDir() {
        //ipcRenderer.send('asy-message-loadjobs', 'ping');
        //document.getElementById("jobs-log").innerHTML="Call setInterval";
        let files = readJobDataDir();
        for (var key in files) {
          console.log(files[key]);
          let j = getJobInfoPanelByJobName(files[key]);
          if (!j) {
            addJobInfoPanel(files[key]);
          }
        }
        this.CheckDirIntervalID = (callJobsDir, 5000);
      }

      require('./renderer-process/jobs/jobs')
    </script>

  </section>
</template>